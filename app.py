{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "577bee8f-c369-41c8-a738-1361a9f6cccb",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 1. é¢„æ£€æŸ¥ä»£ç ï¼ˆå¿…é¡»æ”¾åœ¨æœ€é¡¶éƒ¨ï¼‰\n",
    "import os\n",
    "import sys\n",
    "from pathlib import Path\n",
    "\n",
    "DEPS_LOCK = Path(\".deps_installed\")\n",
    "if not DEPS_LOCK.exists():\n",
    "    print(\"æ­£åœ¨å®‰è£…ä¾èµ–...\", flush=True)\n",
    "    exit_code = os.system(\"pip install --prefer-binary -r requirements.txt\")\n",
    "    if exit_code != 0:\n",
    "        print(\"ä¾èµ–å®‰è£…å¤±è´¥ï¼\", file=sys.stderr)\n",
    "        sys.exit(1)\n",
    "    DEPS_LOCK.touch()\n",
    "    \n",
    "import streamlit as st\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import plotly.graph_objects as go\n",
    "from scipy.interpolate import griddata\n",
    "\n",
    "# é¡µé¢è®¾ç½®\n",
    "st.set_page_config(\n",
    "    page_title=\"è½¦è¾†æ’æ”¾åˆ†æç³»ç»Ÿ\",\n",
    "    page_icon=\"ğŸš—\",\n",
    "    layout=\"wide\"\n",
    ")\n",
    "\n",
    "# è‡ªå®šä¹‰é¢œè‰²æ˜ å°„å‡½æ•°\n",
    "def custom_colormap(efficiency):\n",
    "    \"\"\"åˆ›å»ºä»æ·±è“åˆ°æ·±çº¢çš„æ¸å˜é¢œè‰²æ˜ å°„\"\"\"\n",
    "    if efficiency <= 0.5:\n",
    "        # 0-50%: æ·±è“åˆ°ç»¿è‰²\n",
    "        r = int(0)\n",
    "        g = int(255 * (efficiency / 0.5))\n",
    "        b = int(255 * (1 - efficiency / 0.5))\n",
    "    elif efficiency <= 0.7:\n",
    "        # 50-70%: ç»¿è‰²åˆ°æ©˜çº¢\n",
    "        r = int(255 * ((efficiency - 0.5) / 0.2))\n",
    "        g = 255\n",
    "        b = 0\n",
    "    else:\n",
    "        # 70-100%: æ©˜çº¢åˆ°æ·±çº¢\n",
    "        r = 255\n",
    "        g = int(255 * (1 - (efficiency - 0.7) / 0.3))\n",
    "        b = 0\n",
    "    return f\"rgb({r},{g},{b})\"\n",
    "\n",
    "# è®¡ç®—è½¬åŒ–æ•ˆç‡\n",
    "def calculate_efficiency(upstream, downstream):\n",
    "    \"\"\"è®¡ç®—è½¬åŒ–æ•ˆç‡å¹¶é™åˆ¶åœ¨0-100%ä¹‹é—´\"\"\"\n",
    "    # å¤„ç†é™¤é›¶é”™è¯¯\n",
    "    with np.errstate(divide='ignore', invalid='ignore'):\n",
    "        efficiency = (1 - downstream / upstream) * 100\n",
    "    \n",
    "    # å¤„ç†æ— æ•ˆå€¼\n",
    "    efficiency = np.nan_to_num(efficiency, nan=0.0)\n",
    "    \n",
    "    # é™åˆ¶åœ¨0-100%ä¹‹é—´\n",
    "    efficiency = np.clip(efficiency, 0, 100)\n",
    "    return efficiency\n",
    "\n",
    "# åˆ›å»ºä¸‰ç»´æ›²é¢å›¾\n",
    "def create_3d_surface(flow, temp, efficiency, pollutant_name):\n",
    "    \"\"\"åˆ›å»ºå¯äº¤äº’çš„ä¸‰ç»´æ›²é¢å›¾\"\"\"\n",
    "    # åˆ›å»ºç½‘æ ¼\n",
    "    xi = np.linspace(min(flow), max(flow), 100)\n",
    "    yi = np.linspace(min(temp), max(temp), 100)\n",
    "    xi, yi = np.meshgrid(xi, yi)\n",
    "    \n",
    "    # æ’å€¼å¤„ç†ï¼ˆå¡«å……ç¼ºå¤±å€¼ï¼‰\n",
    "    zi = griddata(\n",
    "        (flow, temp), \n",
    "        efficiency, \n",
    "        (xi, yi), \n",
    "        method='cubic'\n",
    "    )\n",
    "    \n",
    "    # åˆ›å»ºé¢œè‰²æ˜ å°„\n",
    "    colors = np.vectorize(custom_colormap)(zi/100)\n",
    "    \n",
    "    # åˆ›å»º3Dæ›²é¢\n",
    "    fig = go.Figure(data=[\n",
    "        go.Surface(\n",
    "            x=xi, y=yi, z=zi,\n",
    "            surfacecolor=colors,\n",
    "            colorscale=None,\n",
    "            showscale=False,\n",
    "            opacity=0.9,\n",
    "            hoverinfo=\"x+y+z+name\",\n",
    "            name=pollutant_name\n",
    "        )\n",
    "    ])\n",
    "    \n",
    "    # è®¾ç½®å›¾è¡¨å¸ƒå±€\n",
    "    fig.update_layout(\n",
    "        title=f\"{pollutant_name}è½¬åŒ–æ•ˆç‡åˆ†æ\",\n",
    "        scene=dict(\n",
    "            xaxis_title='æµé‡ (mÂ³/h)',\n",
    "            yaxis_title='å‚¬åŒ–å™¨æ¸©åº¦ (Â°C)',\n",
    "            zaxis_title='è½¬åŒ–æ•ˆç‡ (%)',\n",
    "            zaxis=dict(range=[0, 100]),\n",
    "            camera=dict(\n",
    "                eye=dict(x=1.5, y=1.5, z=1.5)\n",
    "            )\n",
    "        ),\n",
    "        autosize=True,\n",
    "        height=800,\n",
    "        margin=dict(l=0, r=0, b=0, t=50)\n",
    "    )\n",
    "    \n",
    "    return fig\n",
    "\n",
    "# ä¸»ç¨‹åº\n",
    "def main():\n",
    "    st.title(\"ğŸš— è½¦è¾†æ’æ”¾ä¸‰ç»´åˆ†æç³»ç»Ÿ\")\n",
    "    st.markdown(\"ä¸Šä¼ è½¦è¾†10Hzæ’æ”¾æ•°æ®Excelæ–‡ä»¶ï¼Œåˆ†æCOã€THCã€NOxçš„è½¬åŒ–æ•ˆç‡\")\n",
    "    \n",
    "    # æ–‡ä»¶ä¸Šä¼ \n",
    "    uploaded_file = st.file_uploader(\n",
    "        \"ä¸Šä¼ Excelæ•°æ®æ–‡ä»¶\", \n",
    "        type=[\"xlsx\", \"xls\"],\n",
    "        help=\"è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼ï¼šç¬¬ä¸€è¡Œç©ºç™½ï¼Œç¬¬äºŒè¡Œä¸ºåˆ—å\"\n",
    "    )\n",
    "    \n",
    "    if uploaded_file:\n",
    "        try:\n",
    "            # è¯»å–Excelæ–‡ä»¶ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œç©ºç™½ï¼‰\n",
    "            df = pd.read_excel(uploaded_file, header=1)\n",
    "            \n",
    "            # é‡å‘½ååˆ—ï¼ˆæ ¹æ®æè¿°çš„é¡ºåºï¼‰\n",
    "            df.columns = [\n",
    "                'æ—¶é—´', 'Lambda', 'å‚¬åŒ–å™¨æ¸©åº¦', \n",
    "                'COåŸæ’', 'COå°¾æ’', \n",
    "                'THCåŸæ’', 'THCå°¾æ’',\n",
    "                'NOxåŸæ’', 'NOxå°¾æ’', 'æµé‡'\n",
    "            ]\n",
    "            \n",
    "            # æ•°æ®é‡‡æ ·ï¼ˆ10Hzæ•°æ®é‡å¤ªå¤§ï¼Œé™é‡‡æ ·åˆ°1Hzï¼‰\n",
    "            df = df.iloc[::10, :]\n",
    "            \n",
    "            # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ\n",
    "            with st.expander(\"æ•°æ®é¢„è§ˆï¼ˆå‰10è¡Œï¼‰\"):\n",
    "                st.dataframe(df.head(10))\n",
    "                \n",
    "            # è®¡ç®—è½¬åŒ–æ•ˆç‡\n",
    "            df['COè½¬åŒ–ç‡'] = calculate_efficiency(df['COåŸæ’'], df['COå°¾æ’'])\n",
    "            df['THCè½¬åŒ–ç‡'] = calculate_efficiency(df['THCåŸæ’'], df['THCå°¾æ’'])\n",
    "            df['NOxè½¬åŒ–ç‡'] = calculate_efficiency(df['NOxåŸæ’'], df['NOxå°¾æ’'])\n",
    "            \n",
    "            # åˆ›å»ºä¸‰ä¸ªæ±¡æŸ“ç‰©å›¾è¡¨\n",
    "            pollutants = {\n",
    "                \"CO\": df['COè½¬åŒ–ç‡'],\n",
    "                \"THC\": df['THCè½¬åŒ–ç‡'],\n",
    "                \"NOx\": df['NOxè½¬åŒ–ç‡']\n",
    "            }\n",
    "            \n",
    "            # ä½¿ç”¨é€‰é¡¹å¡å±•ç¤ºä¸‰ä¸ªå›¾è¡¨\n",
    "            tab1, tab2, tab3 = st.tabs([\"COè½¬åŒ–ç‡\", \"THCè½¬åŒ–ç‡\", \"NOxè½¬åŒ–ç‡\"])\n",
    "            \n",
    "            with tab1:\n",
    "                fig_co = create_3d_surface(\n",
    "                    df['æµé‡'], \n",
    "                    df['å‚¬åŒ–å™¨æ¸©åº¦'], \n",
    "                    df['COè½¬åŒ–ç‡'],\n",
    "                    \"CO\"\n",
    "                )\n",
    "                st.plotly_chart(fig_co, use_container_width=True)\n",
    "                \n",
    "            with tab2:\n",
    "                fig_thc = create_3d_surface(\n",
    "                    df['æµé‡'], \n",
    "                    df['å‚¬åŒ–å™¨æ¸©åº¦'], \n",
    "                    df['THCè½¬åŒ–ç‡'],\n",
    "                    \"THC\"\n",
    "                )\n",
    "                st.plotly_chart(fig_thc, use_container_width=True)\n",
    "                \n",
    "            with tab3:\n",
    "                fig_nox = create_3d_surface(\n",
    "                    df['æµé‡'], \n",
    "                    df['å‚¬åŒ–å™¨æ¸©åº¦'], \n",
    "                    df['NOxè½¬åŒ–ç‡'],\n",
    "                    \"NOx\"\n",
    "                )\n",
    "                st.plotly_chart(fig_nox, use_container_width=True)\n",
    "                \n",
    "            # æ·»åŠ æ•°æ®ç»Ÿè®¡ä¿¡æ¯\n",
    "            st.subheader(\"è½¬åŒ–æ•ˆç‡ç»Ÿè®¡\")\n",
    "            col1, col2, col3 = st.columns(3)\n",
    "            col1.metric(\"COå¹³å‡è½¬åŒ–ç‡\", f\"{df['COè½¬åŒ–ç‡'].mean():.1f}%\")\n",
    "            col2.metric(\"THCå¹³å‡è½¬åŒ–ç‡\", f\"{df['THCè½¬åŒ–ç‡'].mean():.1f}%\")\n",
    "            col3.metric(\"NOxå¹³å‡è½¬åŒ–ç‡\", f\"{df['NOxè½¬åŒ–ç‡'].mean():.1f}%\")\n",
    "            \n",
    "        except Exception as e:\n",
    "            st.error(f\"æ•°æ®å¤„ç†é”™è¯¯: {str(e)}\")\n",
    "            st.exception(e)\n",
    "\n",
    "if __name__ == \"__main__\":\n",
    "    main()"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [conda env:base] *",
   "language": "python",
   "name": "conda-base-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
